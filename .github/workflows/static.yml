# Simple workflow for deploying DocC static site (multi-language) to GitHub Pages
name: DocC Deployment

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

# DocC language configuration (can be modified directly in this file)
env:
  DOCC_DEFAULT_LANG: en
  DOCC_LANGS_JSON: '["en","zh-Hans"]'

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      langs_json: ${{ steps.set.outputs.langs_json }}
      default_lang: ${{ steps.set.outputs.default_lang }}
    steps:
      - name: Export workflow config
        id: set
        shell: bash
        run: |
          set -euo pipefail

          # strategy.matrix cannot read env context directly.
          # Export workflow-level env as job outputs for later jobs.
          printf 'langs_json=%s\n' "$DOCC_LANGS_JSON" >> "$GITHUB_OUTPUT"
          printf 'default_lang=%s\n' "$DOCC_DEFAULT_LANG" >> "$GITHUB_OUTPUT"

  build:
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      matrix:
        lang: ${{ fromJSON(needs.prepare.outputs.langs_json) }}

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Build DocC (${{ matrix.lang }})
        uses: ./.github/actions/docc-build
        with:
          lang: ${{ matrix.lang }}
          default_lang: ${{ needs.prepare.outputs.default_lang }}
          langs_json: ${{ needs.prepare.outputs.langs_json }}
          target: Service
          docc_catalog: Sources/Service/Documentation.docc
          repo_name: ${{ github.event.repository.name }}
          swift_version: "6.2"

  deploy:
    needs: [prepare, build]
    runs-on: ubuntu-latest
    environment:
      name: DocC Site
      url: ${{ steps.pages.outputs.page_url }}

    steps:
      # Required for local actions (./.github/actions/*).
      - name: Checkout
        uses: actions/checkout@v5

      - name: Deploy Pages
        id: pages
        uses: ./.github/actions/docc-pages
        with:
          default_lang: ${{ needs.prepare.outputs.default_lang }}
          langs_json: ${{ needs.prepare.outputs.langs_json }}
          ga_measurement_id: ${{ vars.GA_MEASUREMENT_ID || secrets.GA_MEASUREMENT_ID }}
