# Simple workflow for deploying static content to GitHub Pages
name: DocC Deployment

on:
  # Runs on pushes targeting the default branch
  push:
    branches: ["main"]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "pages"
  cancel-in-progress: false

env:
  DEFAULT_LANGUAGE: en

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        lang: [en, zh-Hans]
    steps:
      - name: Setup Swift
        uses: swift-actions/setup-swift@v3
        with:
          swift-version: "6.2"
          skip-verify-signature: true

      - name: Checkout
        uses: actions/checkout@v5

      - name: Prepare Documentation (${{ matrix.lang }})
        run: |
          if [ "${{ matrix.lang }}" = "$DEFAULT_LANGUAGE" ]; then
            # Hide all localized docs (format: *.LANG.md)
            find Sources/Service/Documentation.docc -name "*.*.md" -type f ! -name "*.hidden" -exec mv {} {}.hidden \; || true
          else
            # Hide default language docs
            find Sources/Service/Documentation.docc/Articles -name "*.md" ! -name "*.*.md" -exec mv {} {}.hidden \; || true
            if [ -f "Sources/Service/Documentation.docc/Service.md" ]; then
              mv Sources/Service/Documentation.docc/Service.md Sources/Service/Documentation.docc/Service.md.hidden
            fi
            # Hide other language docs (not current language)
            find Sources/Service/Documentation.docc -name "*.*.md" ! -name "*.${{ matrix.lang }}.md" -type f ! -name "*.hidden" -exec mv {} {}.hidden \; || true
            # Rename current language docs to replace default language ones
            find Sources/Service/Documentation.docc/Articles -name "*.${{ matrix.lang }}.md" -exec sh -c 'base="${1%.${{ matrix.lang }}.md}"; mv "$1" "${base}.md.tmp"' _ {} \; || true
            if [ -f "Sources/Service/Documentation.docc/Service.${{ matrix.lang }}.md" ]; then
              mv Sources/Service/Documentation.docc/Service.${{ matrix.lang }}.md Sources/Service/Documentation.docc/Service.md.tmp
            fi
          fi

      - name: Generate DocC (${{ matrix.lang }})
        run: |
          set -e
          rm -rf .build/docs-${{ matrix.lang }}
          mkdir -p .build/docs-${{ matrix.lang }}
          if [ "${{ matrix.lang }}" = "$DEFAULT_LANGUAGE" ]; then
            # Default language uses root path
            hosting_path="swift-service"
          else
            # Other languages use language code as subpath
            hosting_path="swift-service/${{ matrix.lang }}"
          fi
          swift package --allow-writing-to-directory .build/docs-${{ matrix.lang }} \
            generate-documentation \
            --output-path .build/docs-${{ matrix.lang }} \
            --transform-for-static-hosting \
            --target Service \
            --hosting-base-path "$hosting_path"
          touch .build/docs-${{ matrix.lang }}/.nojekyll

      - name: Restore files (${{ matrix.lang }})
        if: always()
        run: |
          if [ "${{ matrix.lang }}" = "$DEFAULT_LANGUAGE" ]; then
            # Restore all hidden non-default language docs
            find Sources/Service/Documentation.docc -name "*.md.hidden" -exec sh -c 'mv "$1" "${1%.hidden}"' _ {} \; || true
          else
            # Restore all hidden docs
            find Sources/Service/Documentation.docc -name "*.md.hidden" -exec sh -c 'mv "$1" "${1%.hidden}"' _ {} \; || true
            # Restore renamed current language docs
            find Sources/Service/Documentation.docc/Articles -name "*.md.tmp" -exec sh -c 'mv "$1" "${1%.tmp}.${{ matrix.lang }}.md"' _ {} \; || true
            if [ -f "Sources/Service/Documentation.docc/Service.md.tmp" ]; then
              mv Sources/Service/Documentation.docc/Service.md.tmp Sources/Service/Documentation.docc/Service.${{ matrix.lang }}.md
            fi
          fi

      - name: Upload docs artifact (${{ matrix.lang }})
        uses: actions/upload-artifact@v4
        with:
          name: docs-${{ matrix.lang }}
          path: .build/docs-${{ matrix.lang }}
          retention-days: 1

  deploy:
    needs: build
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Download docs artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: docs-*
          merge-multiple: false

      - name: Combine Documentation
        run: |
          rm -rf .build/docs
          mkdir -p .build/docs
          # Process each language artifact
          for lang_dir in docs-*; do
            lang="${lang_dir#docs-}"
            if [ "$lang" = "$DEFAULT_LANGUAGE" ]; then
              # Default language goes to root
              cp -r "$lang_dir"/* .build/docs/
            else
              # Other languages go to subdirectories
              mkdir -p .build/docs/"$lang"
              cp -r "$lang_dir"/* .build/docs/"$lang"/
            fi
          done
          touch .build/docs/.nojekyll

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.build/docs'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
