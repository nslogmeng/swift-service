# Simple workflow for deploying DocC static site (multi-language) to GitHub Pages
name: DocC Deployment

on:
  push:
    branches: ["main"]
  workflow_dispatch:

# Grant GITHUB_TOKEN the permissions required by GitHub Pages deployment.
permissions:
  contents: read
  pages: write
  id-token: write

# Ensure only one Pages deployment runs at a time (avoid race/conflicts).
concurrency:
  group: "pages"
  cancel-in-progress: false

# DocC language configuration (can be modified directly in this file)
# Default language identifier
env:
  DOCC_DEFAULT_LANG: en
  # All supported languages (including default language) as JSON array
  DOCC_LANGS_JSON: '["en","zh-Hans"]'

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        lang: ${{ fromJSON(env.DOCC_LANGS_JSON) }}

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Build DocC (${{ matrix.lang }})
        uses: ./.github/actions/docc-build
        with:
          lang: ${{ matrix.lang }}
          default_lang: ${{ env.DOCC_DEFAULT_LANG }}
          langs_json: ${{ env.DOCC_LANGS_JSON }}
          target: Service
          docc_catalog: Sources/Service/Documentation.docc
          repo_name: ${{ github.event.repository.name }}
          swift_version: "6.2"

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: DocC Site
      url: ${{ steps.pages.outputs.page_url }}

    steps:
      # Required for local actions (./.github/actions/*).
      - name: Checkout
        uses: actions/checkout@v5

      - name: Deploy Pages
        id: pages
        uses: ./.github/actions/docc-pages
        with:
          default_lang: ${{ env.DOCC_DEFAULT_LANG }}
          langs_json: ${{ env.DOCC_LANGS_JSON }}
          ga_measurement_id: ${{ vars.GA_MEASUREMENT_ID || secrets.GA_MEASUREMENT_ID }}
